<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Pixel Calculator</title>

<style>
html, body {
  margin:0;
  height:100%;
  background:#000;
  font-family:-apple-system;
  color:white;
  overflow:hidden;
  /* Prevent selecting the UI */
  -webkit-user-select: none;
  user-select: none;
  touch-action: manipulation;
}

.calculator {
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
}

/* DISPLAY */

.display {
  background:#2b262b;
  padding:22px 20px;
  height:24vh;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
}

.mainInput {
  font-size:40px;
  background:transparent;
  border:none;
  color:white;
  text-align:right;
  width:100%;
  outline:none;
  caret-color: #8ab4f8; /* Google Blue Cursor */
  font-family: inherit;
  padding: 0;
  margin: 0;
  
  /* CRITICAL: Allows cursor placement inside text */
  -webkit-user-select: text; 
  user-select: text;
}

.preview {
  font-size:50px;
  opacity:0.8;
  margin-top:6px;
  text-align: right;
  min-height: 60px;
}

/* KEYPAD */

.keypad {
  flex:1;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  padding:6px 18px 28px 18px;
}

button {
  aspect-ratio:1/1;
  border-radius:50%;
  border:none;
  font-size:32px;
  color:white;
  background:#1b1b1b;
  -webkit-tap-highlight-color: transparent;
  cursor: pointer;
}

.operator { background:#5c525c; }
.top { background:#4b404b; }
.equals { background: #8ab4f8; color: #000; }

button:active { transform:scale(0.95); }
</style>
</head>

<body>

<div class="calculator">

  <div class="display">
    <input type="text" class="mainInput" id="input" value="0" inputmode="none" spellcheck="false" autocomplete="off">
    <div class="preview" id="preview"></div>
  </div>

  <div class="keypad">
    <button class="top" onmousedown="event.preventDefault()" onclick="insert('Math.sqrt(')">√</button>
    <button class="top" onmousedown="event.preventDefault()" onclick="insert('Math.PI')">π</button>
    <button class="top" onmousedown="event.preventDefault()" onclick="insert('^')">^</button>
    <button class="top" onmousedown="event.preventDefault()" onclick="clearAll()">AC</button>

    <button class="top" onmousedown="event.preventDefault()" onclick="insert('(')">(</button>
    <button class="top" onmousedown="event.preventDefault()" onclick="insert(')')">)</button>
    <button class="operator" onmousedown="event.preventDefault()" onclick="insert('/')">÷</button>
    <button class="operator" onmousedown="event.preventDefault()" onclick="back()">⌫</button>

    <button onmousedown="event.preventDefault()" onclick="insert('7')">7</button>
    <button onmousedown="event.preventDefault()" onclick="insert('8')">8</button>
    <button onmousedown="event.preventDefault()" onclick="insert('9')">9</button>
    <button class="operator" onmousedown="event.preventDefault()" onclick="insert('*')">×</button>

    <button onmousedown="event.preventDefault()" onclick="insert('4')">4</button>
    <button onmousedown="event.preventDefault()" onclick="insert('5')">5</button>
    <button onmousedown="event.preventDefault()" onclick="insert('6')">6</button>
    <button class="operator" onmousedown="event.preventDefault()" onclick="insert('-')">−</button>

    <button onmousedown="event.preventDefault()" onclick="insert('1')">1</button>
    <button onmousedown="event.preventDefault()" onclick="insert('2')">2</button>
    <button onmousedown="event.preventDefault()" onclick="insert('3')">3</button>
    <button class="operator" onmousedown="event.preventDefault()" onclick="insert('+')">+</button>

    <button onmousedown="event.preventDefault()" onclick="toggleSign()">±</button>
    <button onmousedown="event.preventDefault()" onclick="insert('0')">0</button>
    <button onmousedown="event.preventDefault()" onclick="insert('.')">.</button>
    <button class="equals" onmousedown="event.preventDefault()" onclick="calculate()">=</button>

  </div>

</div>

<script>

const inputField = document.getElementById("input");
const preview = document.getElementById("preview");

// Prevent double-tap zoom
document.addEventListener('dblclick', function(event) {
  event.preventDefault();
}, { passive: false });

function insert(val) {
    const start = inputField.selectionStart;
    const end = inputField.selectionEnd;
    let current = inputField.value;

    // Logic to replace initial "0"
    if (current === "0" && !isNaN(val) && val !== '.') {
        inputField.value = val;
    } else {
        // Insert text exactly where the cursor is
        inputField.value = current.substring(0, start) + val + current.substring(end);
        
        // Move cursor to AFTER the new character
        inputField.selectionStart = inputField.selectionEnd = start + val.length;
    }
    
    // Trigger live calculation
    liveCalculate();
}

function back() {
    const start = inputField.selectionStart;
    const end = inputField.selectionEnd;
    let current = inputField.value;

    if (start === end) {
        // No selection: delete character BEFORE cursor
        if (start > 0) {
            inputField.value = current.substring(0, start - 1) + current.substring(end);
            inputField.selectionStart = inputField.selectionEnd = start - 1;
        }
    } else {
        // Selection active: delete selected text
        inputField.value = current.substring(0, start) + current.substring(end);
        inputField.selectionStart = inputField.selectionEnd = start;
    }
    
    if (inputField.value === "") inputField.value = "0";
    liveCalculate();
}

function clearAll() {
    inputField.value = "0";
    preview.innerText = "";
}

/* CALCULATION LOGIC */

function formatExpression(exp) {
    exp = exp.replace(/×/g, "*");
    exp = exp.replace(/÷/g, "/");
    exp = exp.replace(/−/g, "-");
    // Implicit multiplication
    exp = exp.replace(/(\d)\(/g, "$1*(");
    exp = exp.replace(/\)(\d)/g, ")*$1");
    return exp;
}

function liveCalculate() {
    try {
        let val = inputField.value;
        if (!val || val === "0") {
            preview.innerText = "";
            return;
        }
        let exp = formatExpression(val).replace(/\^/g, "**");
        let result = eval(exp);
        if (result !== undefined && !isNaN(result) && result !== Infinity) {
            preview.innerText = Number(result).toLocaleString(undefined, {maximumFractionDigits: 10});
        } else {
            preview.innerText = "";
        }
    } catch (e) {
        preview.innerText = "";
    }
}

function calculate() {
    try {
        let exp = formatExpression(inputField.value).replace(/\^/g, "**");
        let result = eval(exp);
        if (isNaN(result) || result === undefined) throw "Error";
        inputField.value = result.toString();
        preview.innerText = "";
    } catch {
        inputField.value = "Error";
        setTimeout(() => inputField.value = "0", 1500);
    }
}

function toggleSign() {
    let val = inputField.value;
    if (val.startsWith("-")) {
        inputField.value = val.substring(1);
    } else {
        inputField.value = "-" + val;
    }
    liveCalculate();
}

</script>

</body>
</html>
